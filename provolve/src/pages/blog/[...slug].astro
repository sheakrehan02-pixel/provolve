---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog');
  return blogPosts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content } = await post.render();

const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter((p) => p.slug !== post.slug)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3);
---

<Layout title={post.data.title} description={post.data.description} canonicalURL={`https://provolve.net/blog/${post.slug}/`}>
  <article class="max-w-[72ch] mx-auto">
    <a href="/" class="inline-flex items-center gap-1.5 text-sm font-medium text-truffle-brown/70 hover:text-truffle-caramel mb-8 link-underline transition-colors duration-200">
      <span aria-hidden="true">←</span>
      Back to all articles
    </a>

    <header class="mb-10">
      <time class="text-xs text-truffle-brown/55" datetime={post.data.pubDate.toISOString()}>
        {post.data.pubDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
      </time>
      <h1 class="font-serif text-2xl sm:text-3xl md:text-[2.25rem] font-semibold text-truffle-dark-brown leading-[1.25] mt-2">
        {post.data.title}
      </h1>
      {post.data.description && (
        <p class="text-lg text-truffle-brown/85 leading-relaxed mt-4 max-w-[65ch]">
          {post.data.description}
        </p>
      )}
      <div class="mt-8 h-px bg-gradient-to-r from-transparent via-truffle-brown/15 to-transparent"></div>
    </header>

    <div class="blog-content">
      <Content />
    </div>

    <style>
      .blog-content {
        font-size: 1.0625rem;
        line-height: 1.68;
        color: var(--text-body, rgba(56, 36, 13, 0.88));
        max-width: 65ch;
      }
      .blog-content > * + * {
        margin-top: 1.25rem;
      }
      .blog-content p:first-of-type {
        font-size: 1.125rem;
        line-height: 1.7;
        color: rgba(56, 36, 13, 0.92);
      }
      .blog-content p {
        margin-bottom: 0;
      }
      .blog-content h2 {
        font-family: var(--font-serif, 'Cormorant Garamond', Georgia, serif);
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-heading, #38240D);
        margin-top: 2.5rem;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(192, 88, 0, 0.2);
      }
      .blog-content h2:first-child {
        margin-top: 0;
      }
      .blog-content h3 {
        font-family: var(--font-serif);
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-heading);
        margin-top: 2rem;
        margin-bottom: 0.5rem;
      }
      .blog-content strong {
        font-weight: 600;
        color: var(--text-heading);
      }
      .blog-content a {
        color: #C05800;
        font-weight: 500;
        text-decoration: none;
        border-bottom: 1px solid rgba(192, 88, 0, 0.35);
        transition: color 0.2s, border-color 0.2s;
      }
      .blog-content a:hover {
        color: #713600;
        border-bottom-color: #713600;
      }
      .blog-content blockquote {
        margin: 1.75rem 0;
        padding: 1rem 0 1rem 1.25rem;
        border-left: 3px solid #C05800;
        background: rgba(192, 88, 0, 0.04);
        font-style: italic;
        color: rgba(56, 36, 13, 0.85);
      }
      .blog-content ul, .blog-content ol {
        margin: 1.25rem 0;
        padding-left: 1.35rem;
      }
      .blog-content li {
        margin-bottom: 0.35rem;
        line-height: 1.65;
      }
      .blog-content hr {
        margin: 2rem 0;
        border: none;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(113, 54, 0, 0.15), transparent);
      }
      .blog-content code {
        background: rgba(192, 88, 0, 0.1);
        color: #C05800;
        padding: 0.15em 0.4em;
        border-radius: 3px;
        font-size: 0.9em;
      }
    </style>

    <footer class="mt-14 pt-8 border-t border-truffle-brown/10">
      {relatedPosts.length > 0 && (
        <div class="mb-8">
          <h2 class="font-serif text-lg font-semibold text-truffle-dark-brown mb-4">More articles</h2>
          <ul class="space-y-3">
            {relatedPosts.map((p) => (
              <li>
                <a href={`/blog/${p.slug}/`} class="link-underline text-truffle-brown/85 hover:text-truffle-caramel transition-colors duration-200 font-medium">
                  {p.data.title}
                </a>
              </li>
            ))}
          </ul>
        </div>
      )}
      <a href="/" class="inline-flex items-center gap-2 text-sm font-medium text-truffle-dark-brown/90 hover:text-truffle-caramel link-underline transition-colors duration-200">
        <span aria-hidden="true">←</span>
        Back to all posts
      </a>
    </footer>
  </article>
</Layout>
